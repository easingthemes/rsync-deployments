#!/usr/bin/env node
(()=>{var e={898:(e,r,s)=>{"use strict";var t=s(81).spawn;var o=s(837);var escapeSpaces=function(e){if(typeof e==="string"){return e.replace(/\b\s/g,"\\ ")}else{return e}};var escapeSpacesInOptions=function(e){["src","dest","include","exclude","excludeFirst"].forEach((function(r){var s=e[r];if(typeof s==="string"){e[r]=escapeSpaces(s)}else if(Array.isArray(s)===true){e[r]=s.map(escapeSpaces)}}));return e};e.exports=function(e,r){e=e||{};e=o._extend({},e);e=escapeSpacesInOptions(e);var s=e.platform||process.platform;var n=s==="win32";if(typeof e.src==="undefined"){throw new Error("'src' directory is missing from options")}if(typeof e.dest==="undefined"){throw new Error("'dest' directory is missing from options")}var c=e.dest;if(typeof e.host!=="undefined"){c=e.host+":"+e.dest}if(!Array.isArray(e.src)){e.src=[e.src]}var i=[].concat(e.src);i.push(c);var a=(e.args||[]).find((function(e){return e.match(/--chmod=/)}));if(n&&!a){i.push("--chmod=ugo=rwX")}if(typeof e.host!=="undefined"||e.ssh){i.push("--rsh");var d="ssh";if(typeof e.port!=="undefined"){d+=" -p "+e.port}if(typeof e.privateKey!=="undefined"){d+=" -i "+e.privateKey}if(typeof e.sshCmdArgs!=="undefined"){d+=" "+e.sshCmdArgs.join(" ")}i.push(d)}if(e.recursive===true){i.push("--recursive")}if(e.times===true){i.push("--times")}if(e.syncDest===true||e.deleteAll===true){i.push("--delete");i.push("--delete-excluded")}if(e.syncDestIgnoreExcl===true||e.delete===true){i.push("--delete")}if(e.dryRun===true){i.push("--dry-run");i.push("--verbose")}if(typeof e.excludeFirst!=="undefined"&&o.isArray(e.excludeFirst)){e.excludeFirst.forEach((function(e,r){i.push("--exclude="+e)}))}if(typeof e.include!=="undefined"&&o.isArray(e.include)){e.include.forEach((function(e,r){i.push("--include="+e)}))}if(typeof e.exclude!=="undefined"&&o.isArray(e.exclude)){e.exclude.forEach((function(e,r){i.push("--exclude="+e)}))}switch(e.compareMode){case"sizeOnly":i.push("--size-only");break;case"checksum":i.push("--checksum");break}if(typeof e.args!=="undefined"&&o.isArray(e.args)){i=[...new Set([...i,...e.args])]}i=[...new Set(i)];var noop=function(){};var l=e.onStdout||noop;var u=e.onStderr||noop;var f="rsync ";i.forEach((function(e){if(e.substr(0,4)==="ssh "){e='"'+e+'"'}f+=e+" "}));f=f.trim();if(e.noExec){r(null,null,null,f);return}try{var p="";var h="";var y;if(n){y=t("cmd.exe",["/s","/c",'"'+f+'"'],{windowsVerbatimArguments:true,stdio:[process.stdin,"pipe","pipe"]})}else{y=t("/bin/sh",["-c",f])}y.stdout.on("data",(function(e){l(e);p+=e}));y.stderr.on("data",(function(e){u(e);h+=e}));y.on("exit",(function(e){var s=null;if(e!==0){s=new Error("rsync exited with code "+e);s.code=e}r(s,p,h,f)}))}catch(e){r(e,null,null,f)}}},505:(e,r,s)=>{const{existsSync:t,mkdirSync:o,writeFileSync:n}=s(147);const{join:c}=s(17);const validateDir=e=>{if(!e){console.log("[DIR] dir is not defined");return}if(t(e)){console.log(`[DIR] ${e} dir exist`);return}console.log(`[DIR] Creating ${e} dir in workspace root`);o(e);console.log("✅ [DIR] dir created.")};const writeToFile=({dir:e,filename:r,content:s,isRequired:o})=>{validateDir(e);const i=c(e,r);if(t(i)){console.log(`[FILE] ${i} file exist`);if(o){throw new Error(`⚠️ [FILE] ${i} Required file exist, aborting ...`)}return}try{console.log(`[FILE] writing ${i} file ...`,s.length);n(i,s,{encoding:"utf8",mode:384})}catch(e){throw new Error(`⚠️[FILE] Writing to file error. filePath: ${i}, message:  ${e.message}`)}};const validateRequiredInputs=e=>{const r=Object.keys(e);const s=r.filter((r=>{const s=e[r];if(!s){console.error(`⚠️ [INPUTS] ${r} is mandatory`)}return s}));if(s.length!==r.length){throw new Error("⚠️ [INPUTS] Inputs not valid, aborting ...")}};const snakeToCamel=e=>e.replace(/[^a-zA-Z0-9]+(.)/g,((e,r)=>r.toUpperCase()));e.exports={writeToFile:writeToFile,validateRequiredInputs:validateRequiredInputs,snakeToCamel:snakeToCamel}},229:(e,r,s)=>{const{snakeToCamel:t}=s(505);const o=["REMOTE_HOST","REMOTE_USER","REMOTE_PORT","SSH_PRIVATE_KEY","DEPLOY_KEY_NAME","SOURCE","TARGET","ARGS","SSH_CMD_ARGS","EXCLUDE","SCRIPT_BEFORE","SCRIPT_AFTER"];const n=process.env.GITHUB_WORKSPACE;const c=process.env.REMOTE_USER;const i={source:"",target:`/home/${c}/`,exclude:"",args:"-rltgoDzvO",sshCmdArgs:"-o StrictHostKeyChecking=no",deployKeyName:"deploy_key"};const a={githubWorkspace:n};o.forEach((e=>{const r=t(e.toLowerCase());const s=process.env[e]||process.env[`INPUT_${e}`];const o=s===undefined?i[r]:s;let c=o;switch(r){case"source":c=`${n}/${o}`;break;case"exclude":case"args":case"sshCmdArgs":c=o.split(",").map((e=>e.trim()));break}a[r]=c}));a.sshServer=`${a.remoteUser}@${a.remoteHost}`;a.rsyncServer=`${a.remoteUser}@${a.remoteHost}:${a.target}`;e.exports=a},976:(e,r,s)=>{const{exec:t}=s(81);const{privateKey:o,sshServer:n,githubWorkspace:c}=s(229);const{writeToFile:i}=s(505);const handleError=(e,r,s)=>{const t=`⚠️ [CMD] Remote script failed: ${e}`;if(r){s(new Error(t))}else{console.log(t)}};const remoteCmd=async(e,r,s)=>new Promise(((a,d)=>{const l=`local_ssh_script-${r}.sh`;try{i({dir:c,filename:l,content:e});t(`ssh -i ${o} ${n} 'RSYNC_STDOUT=${process.env.RSYNC_STDOUT} bash -s' < ${l}`,((e,r,t)=>{if(e){handleError(e.message,s,d)}else{console.log("✅ [CMD] Remote script executed. \n",r,t);a(r)}}))}catch(e){handleError(e.message,s,d)}}));e.exports={remoteCmdBefore:async(e,r)=>remoteCmd(e,"before",r),remoteCmdAfter:async(e,r)=>remoteCmd(e,"after",r)}},447:(e,r,s)=>{const{execSync:t}=s(81);const o=s(898);const{writeToFile:n}=s(505);const nodeRsyncPromise=async e=>new Promise(((r,s)=>{try{o(e,((e,t,o,n)=>{if(e){console.log("⚠️ [Rsync] stderr: ",o);console.log("⚠️ [Rsync] stdout: ",t);console.log("⚠️ [Rsync] cmd: ",n);s(e)}else{r(t)}}))}catch(e){console.error("⚠️ [Rsync] command error: ",e.message,e.stack);s(e)}}));const validateRsync=async()=>{try{t("rsync --version",{stdio:"inherit"});console.log("⚠️ [CLI] Rsync exists");return}catch(e){console.log("⚠️ [CLI] Rsync doesn't exists",e)}console.log('⚠️ [CLI] Start rsync installation with "apt-get" \n');try{t("sudo DEBIAN_FRONTEND=noninteractive apt-get -y update && sudo DEBIAN_FRONTEND=noninteractive apt-get --no-install-recommends -y install rsync",{stdio:"inherit"});console.log("✅ [CLI] Rsync installed. \n")}catch(e){throw new Error(`⚠️ [CLI] Rsync installation failed. Aborting ... error: ${e.message}`)}};const rsyncCli=async({source:e,rsyncServer:r,exclude:s,remotePort:t,privateKeyPath:o,args:n,sshCmdArgs:c})=>{console.log(`[Rsync] Starting Rsync Action: ${e} to ${r}`);if(s)console.log(`[Rsync] excluding folders ${s}`);const i={ssh:true,recursive:true};return nodeRsyncPromise({...i,src:e,dest:r,excludeFirst:s,port:t,privateKey:o,args:n,sshCmdArgs:c})};const sshDeploy=async e=>{await validateRsync();const r=await rsyncCli(e);console.log("✅ [Rsync] finished.",r);process.env.RSYNC_STDOUT=r;return r};e.exports={sshDeploy:sshDeploy}},822:(e,r,s)=>{const{join:t}=s(17);const{writeToFile:o}=s(505);const getPrivateKeyPath=e=>{const{HOME:r}=process.env;const s=t(r||__dirname,".ssh");return{dir:s,filename:e,path:t(s,e)}};const addSshKey=(e,r)=>{const{dir:s,filename:t}=getPrivateKeyPath(r);o({dir:s,filename:"known_hosts",content:""});console.log("✅ [SSH] known_hosts file ensured",s);o({dir:s,filename:t,content:e,isRequired:true});console.log("✅ [SSH] key added to `.ssh` dir ",s,t)};e.exports={getPrivateKeyPath:getPrivateKeyPath,addSshKey:addSshKey}},81:e=>{"use strict";e.exports=require("child_process")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")},837:e=>{"use strict";e.exports=require("util")}};var r={};function __nccwpck_require__(s){var t=r[s];if(t!==undefined){return t.exports}var o=r[s]={exports:{}};var n=true;try{e[s](o,o.exports,__nccwpck_require__);n=false}finally{if(n)delete r[s]}return o.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var s={};(()=>{const{sshDeploy:e}=__nccwpck_require__(447);const{remoteCmdBefore:r,remoteCmdAfter:s}=__nccwpck_require__(976);const{addSshKey:t,getPrivateKeyPath:o}=__nccwpck_require__(822);const{validateRequiredInputs:n}=__nccwpck_require__(505);const c=__nccwpck_require__(229);const run=async()=>{const{source:i,remoteUser:a,remoteHost:d,remotePort:l,deployKeyName:u,sshPrivateKey:f,args:p,exclude:h,sshCmdArgs:y,scriptBefore:m,scriptAfter:g,rsyncServer:_}=c;n({sshPrivateKey:f,remoteHost:d,remoteUser:a});t(f,u);const{path:v}=o(u);if(m){await r(m)}await e({source:i,rsyncServer:_,exclude:h,remotePort:l,privateKeyPath:v,args:p,sshCmdArgs:y});if(g){await s(g)}};run().then((()=>{console.log("DONE")})).catch((()=>{console.error("ERROR")}))})();module.exports=s})();